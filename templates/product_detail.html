{% extends "base.html" %}

{% block title %}{{ product.name }} - МЕТРИКС{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Главная</a></li>
            <li class="breadcrumb-item"><a href="/catalog" class="text-decoration-none">Каталог</a></li>
            <li class="breadcrumb-item"><a href="/catalog" class="text-decoration-none">{{ product.category }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Product Images -->
        <div class="col-lg-6 mb-4">
            <div class="product-images">
                <!-- Main Image -->
                <div class="main-image-container mb-3" style="height: 400px; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
                    <img src="{{ product.image or '/static/images/bolts/bolt-silver.png' }}" 
                         class="w-100 h-100" 
                         alt="{{ product.name }}"
                         style="object-fit: contain; padding: 20px;">
                </div>
                
                <!-- Dimensions Image (Second Image) -->
                {% if product.diameter_length or product.length or product.width or product.height %}
                <div class="dimensions-image-container" style="height: 300px; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <h6 class="text-muted mb-3">Размеры и характеристики</h6>
                            <div class="dimensions-info">
                                {% if product.diameter_length %}
                                <div class="mb-2">
                                    <strong>Диаметр/Длина:</strong> {{ product.diameter_length }}
                                </div>
                                {% endif %}
                                {% if product.length %}
                                <div class="mb-2">
                                    <strong>Длина:</strong> {{ product.length }} мм
                                </div>
                                {% endif %}
                                {% if product.width %}
                                <div class="mb-2">
                                    <strong>Ширина:</strong> {{ product.width }} мм
                                </div>
                                {% endif %}
                                {% if product.height %}
                                <div class="mb-2">
                                    <strong>Высота:</strong> {{ product.height }} мм
                                </div>
                                {% endif %}
                                {% if product.weight %}
                                <div class="mb-2">
                                    <strong>Вес:</strong> {{ product.weight }} г
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-lg-6">
            <div class="product-info">
                <h1 class="h2 mb-3">{{ product.name }}</h1>
                
                <!-- Category Badge -->
                <div class="mb-3">
                    <span class="badge bg-primary">{{ product.category }}</span>
                </div>

                <!-- Description -->
                {% if product.description %}
                <div class="mb-4">
                    <h5>Описание</h5>
                    <div class="text-muted">{{ product.description | safe }}</div>
                </div>
                {% endif %}

                <!-- Technical Specifications -->
                <div class="mb-4">
                    <h5>Технические характеристики</h5>
                    <div class="row">
                        {% if product.standard %}
                        <div class="col-md-6 mb-2">
                            <strong>Стандарт:</strong> {{ product.standard }}
                        </div>
                        {% endif %}
                        {% if product.brand %}
                        <div class="col-md-6 mb-2">
                            <strong>Бренд:</strong> {{ product.brand }}
                        </div>
                        {% endif %}
                        {% if product.sku %}
                        <div class="col-md-6 mb-2">
                            <strong>Артикул:</strong> {{ product.sku }}
                        </div>
                        {% endif %}
                        {% if product.material %}
                        <div class="col-md-6 mb-2">
                            <strong>Материал:</strong> {{ product.material }}
                        </div>
                        {% endif %}
                        {% if product.application %}
                        <div class="col-md-6 mb-2">
                            <strong>Применение:</strong> {{ product.application }}
                        </div>
                        {% endif %}
                        {% if product.analogs %}
                        <div class="col-md-6 mb-2">
                            <strong>Аналоги:</strong> {{ product.analogs }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Additional Specifications -->
                {% if product.drive or product.thread_diameter or product.bracket_length %}
                <div class="mb-4">
                    <h5>Дополнительные параметры</h5>
                    <div class="row">
                        {% if product.drive %}
                        <div class="col-md-6 mb-2">
                            <strong>Привод:</strong> {{ product.drive }}
                        </div>
                        {% endif %}
                        {% if product.thread_diameter %}
                        <div class="col-md-6 mb-2">
                            <strong>Диаметр резьбы:</strong> {{ product.thread_diameter }}
                        </div>
                        {% endif %}
                        {% if product.bracket_length %}
                        <div class="col-md-6 mb-2">
                            <strong>Длина кронштейна:</strong> {{ product.bracket_length }}
                        </div>
                        {% endif %}
                        {% if product.editions %}
                        <div class="col-md-6 mb-2">
                            <strong>Исполнения:</strong> {{ product.editions }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-md-block">
                    <button class="btn btn-primary btn-lg me-md-2" onclick="addToCart('{{ product.id }}', '{{ product.name }}')">
                        <i class="bi bi-cart-plus"></i> Добавить в корзину
                    </button>
                    <a href="/catalog" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Назад к каталогу
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">Похожие товары</h3>
            <div class="row" id="related-products">
                <!-- Related products will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Add to Cart Modal -->
<div class="modal fade" id="addToCartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить в корзину</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-to-cart-form">
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Количество *</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
                        <div class="form-text">Минимальный заказ: 100 шт.</div>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddToCart()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentProductId = '';
let currentProductName = '';

function addToCart(productId, productName) {
    currentProductId = productId;
    currentProductName = productName;
    const modal = new bootstrap.Modal(document.getElementById('addToCartModal'));
    modal.show();
}

function confirmAddToCart() {
    const quantity = document.getElementById('quantity').value;
    const comment = document.getElementById('comment').value;
    
    if (!quantity || quantity < 1) {
        alert('Пожалуйста, укажите количество');
        return;
    }
    
    // Add to cart logic
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existingItem = cart.find(item => item.id === currentProductId);
    
    if (existingItem) {
        existingItem.quantity += parseInt(quantity);
        if (comment) {
            existingItem.comment = comment;
        }
    } else {
        cart.push({
            id: currentProductId,
            name: currentProductName,
            quantity: parseInt(quantity),
            comment: comment,
            image: '{{ product.image }}'
        });
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Update cart count
    updateCartCount();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addToCartModal'));
    modal.hide();
    
    // Show success message
    alert('Товар добавлен в корзину!');
}

function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
        cartCountElement.textContent = totalItems;
    }
}

// Load related products
function loadRelatedProducts() {
    const currentCategory = '{{ product.category }}';
    const currentId = '{{ product.id }}';
    
    // Load products from catalog page
    fetch('/catalog')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const productsData = doc.querySelector('#products-data');
            
            if (productsData) {
                try {
                    const products = JSON.parse(productsData.textContent);
                    const relatedProducts = products
                        .filter(p => p.category === currentCategory && p.id !== currentId)
                        .slice(0, 3);
                    
                    renderRelatedProducts(relatedProducts);
                } catch (e) {
                    console.error('Error parsing products data:', e);
                }
            }
        });
}

function renderRelatedProducts(products) {
    const container = document.getElementById('related-products');
    if (!container || products.length === 0) return;
    
    container.innerHTML = products.map(product => `
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card product-card h-100 shadow-sm">
                <div class="card-img-top-container" style="height: 200px; overflow: hidden; background: #f8f9fa;">
                    <img src="${product.image || '/static/images/bolts/bolt-silver.png'}" 
                         class="card-img-top product-image" 
                         alt="${product.name}"
                         style="width: 100%; height: 100%; object-fit: contain; padding: 15px;">
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text text-muted flex-grow-1">${product.description || ''}</p>
                    <div class="mt-auto">
                        <a href="/product/${product.id}" class="btn btn-outline-primary btn-sm">
                            Подробнее
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateCartCount();
    loadRelatedProducts();
});
</script>
{% endblock %}
